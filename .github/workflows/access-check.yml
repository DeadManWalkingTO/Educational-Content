name: Access Check (GitHub App)

on:
  workflow_dispatch:

jobs:
  app-access:
    name: Verify App token, API & push
    runs-on: ubuntu-latest

    permissions:
      contents: write   # επιτρέπει checkout/push όταν χρησιμοποιείται το app token

    steps:
      - name: Create installation token (GitHub App)
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.APP_ID }}              # APP_ID ως Repository Variable
          private-key: ${{ secrets.PRIVATE_KEY }} # PRIVATE_KEY ως Secret

      - name: Show token scope (diagnostic)
        run: |
          echo "Installation ID: ${{ steps.app-token.outputs.installation-id }}"
          echo "App slug:        ${{ steps.app-token.outputs.app-slug }}"
          echo "Repo:            ${{ github.repository }}"
          echo "Actor:           ${{ github.actor }}"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Checkout using App token
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          persist-credentials: false   # ΜΗΝ αποθηκεύσεις το default GITHUB_TOKEN

      - name: Configure git remote with App installation token
        run: |
          git remote set-url origin "https://x-access-token:${TOKEN}@github.com/${{ github.repository }}.git"
        env:
          TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Minimal API call with GH CLI (issues list)
        run: |
          gh api "repos/${{ github.repository }}/issues" --jq '.[0].title' || true
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      # --- Προαιρετικό: δοκιμαστικό branch/commit/push ---
      - name: Create test branch, commit and push (optional)
        run: |
          BR="access-check/$(date +'%Y%m%d-%H%M%S')"
          git checkout -b "$BR"
          echo "[Access-Check] $(date)" > ACCESS_CHECK.txt
          git add ACCESS_CHECK.txt
          git -c user.name="${{ steps.app-token.outputs.app-slug }}[bot]" \
              -c user.email="${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com" \
              commit -m "chore(access-check): token works (create file & push)"
          git push -u origin "$BR"
